
<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Domino Casino - Player vs AI</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; font-family: sans-serif; }
        #ui { position: absolute; top: 15px; width: 100%; display: flex; justify-content: space-around; pointer-events: none; z-index: 100; }
        .pill { background: rgba(0,0,0,0.8); color: #ffd700; padding: 10px 20px; border-radius: 25px; border: 2px solid #ffd700; font-weight: bold; font-size: 14px; }
        #status-msg { position: absolute; bottom: 30px; width: 100%; text-align: center; color: #fff; font-size: 18px; font-weight: bold; text-shadow: 2px 2px 5px #000; pointer-events: none; }
    </style>
</head>
<body>
    <div id="ui">
        <div class="pill">خصم: <span id="ai-count">7</span></div>
        <div class="pill" id="turn-display">دورك الآن</div>
        <div class="pill">أنت: <span id="player-count">7</span></div>
    </div>
    <div id="status-msg">اسحب حجرك الأبيض وضعه في المنتصف</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // --- النظام الصوتي ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playClack() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = 'square'; osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.05);
            g.gain.setValueAtTime(0.2, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.08);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        // --- إعداد المشهد ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 18, 15); camera.lookAt(0, -2, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const sun = new THREE.DirectionalLight(0xffffff, 0.8);
        sun.position.set(5, 20, 10); sun.castShadow = true;
        scene.add(sun);

        // الطاولة
        const felt = new THREE.Mesh(new THREE.BoxGeometry(32, 0.2, 22), new THREE.MeshStandardMaterial({ color: 0x0a3d16 }));
        felt.receiveShadow = true; scene.add(felt);
        const woodMat = new THREE.MeshStandardMaterial({ color: 0x4a0a0a, metalness: 0.4, roughness: 0.2 });
        const f1 = new THREE.Mesh(new THREE.BoxGeometry(34, 1.2, 1), woodMat); f1.position.set(0, 0.4, 11); scene.add(f1);
        const f2 = new THREE.Mesh(new THREE.BoxGeometry(34, 1.2, 1), woodMat); f2.position.set(0, 0.4, -11); scene.add(f2);

        // --- منطق اللعبة ---
        let playerHand = [], aiHand = [];
        let edges = { l: {x: -1.2, val: 6}, r: {x: 1.2, val: 6} };
        let isPlayerTurn = true;

        function createTile(v1, v2, x, z, owner) {
            const group = new THREE.Group();
            const shape = new THREE.Shape();
            const w=1, l=2, r=0.2;
            shape.moveTo(-w/2+r, -l/2); shape.lineTo(w/2-r, -l/2); shape.absarc(w/2-r, -l/2+r, r, 1.5*Math.PI, 0, false);
            shape.lineTo(w/2, l/2-r); shape.absarc(w/2-r, l/2-r, r, 0, 0.5*Math.PI, false);
            shape.lineTo(-w/2+r, l/2); shape.absarc(-w/2+r, l/2-r, r, 0.5*Math.PI, Math.PI, false);
            shape.lineTo(-w/2, -l/2+r); shape.absarc(-w/2+r, -l/2+r, r, Math.PI, 1.5*Math.PI, false);

            const body = new THREE.Mesh(
                new THREE.ExtrudeGeometry(shape, {depth:0.25, bevelEnabled:true, bevelSegments:10, bevelSize:0.04, bevelThickness:0.04}),
                new THREE.MeshStandardMaterial({ color: 0xfafaf5, roughness: 0.05 })
            );
            body.rotation.x = -Math.PI/2; body.castShadow = true; group.add(body);

            // النقاط والخط (تظهر فقط للاعب أو على الطاولة)
            if(owner !== 'ai') {
                const line = new THREE.Mesh(new THREE.PlaneGeometry(0.9, 0.03), new THREE.MeshBasicMaterial({color:0x000}));
                line.rotation.x = -Math.PI/2; line.position.y = 0.15; group.add(line);
                const drawPips = (val, zOff) => {
                    const g=0.32; let p=[];
                    if(val%2!==0) p.push([0,0]); if(val>=2) p.push([g,g], [-g,-g]); if(val>=4) p.push([-g,g], [g,-g]); if(val===6) p.push([g,0], [-g,0]);
                    p.forEach(pos => {
                        const d = new THREE.Mesh(new THREE.SphereGeometry(0.09,16,16), new THREE.MeshStandardMaterial({color:0x000}));
                        d.position.set(pos[0], 0.14, zOff+pos[1]); group.add(d);
                    });
                };
                drawPips(v1, 0.5); drawPips(v2, -0.5);
            } else {
                // حجارة الكمبيوتر تظهر مقلوبة
                body.rotation.x = Math.PI/2;
            }

            group.position.set(x, 0.15, z);
            group.userData = { v1, v2, owner, ox:x, oz:z, isD:v1===v2 };
            scene.add(group);
            return group;
        }

        // توزيع عشوائي
        const allTiles = [];
        for(let i=0; i<=6; i++) for(let j=i; j<=6; j++) allTiles.push([i,j]);
        allTiles.sort(() => Math.random() - 0.5);

        for(let i=0; i<7; i++) playerHand.push(createTile(...allTiles.pop(), -6+(i*2), 8, 'player'));
        for(let i=0; i<7; i++) aiHand.push(createTile(...allTiles.pop(), -6+(i*2), -8, 'ai'));
        createTile(6, 6, 0, 0, 'board'); // حجر السنتر

        // --- ذكاء الكمبيوتر ---
        function aiPlay() {
            if(isPlayerTurn) return;
            document.getElementById('turn-display').innerText = "الخصم يفكر...";
            
            setTimeout(() => {
                let playableIdx = aiHand.findIndex(t => 
                    t.userData.v1 === edges.l.val || t.userData.v2 === edges.l.val || 
                    t.userData.v1 === edges.r.val || t.userData.v2 === edges.r.val
                );

                if(playableIdx !== -1) {
                    let tile = aiHand[playableIdx];
                    // كشف الحجر قبل اللعب
                    tile.children[0].rotation.x = -Math.PI/2; 
                    
                    if(tile.userData.v1 === edges.r.val || tile.userData.v2 === edges.r.val) snap(tile, 'r');
                    else snap(tile, 'l');

                    aiHand.splice(playableIdx, 1);
                    document.getElementById('ai-count').innerText = aiHand.length;
                    playClack();
                } else {
                    document.getElementById('status-msg').innerText = "الخصم لم يجد حجرًا.. دورك!";
                }
                isPlayerTurn = true;
                document.getElementById('turn-display').innerText = "دورك الآن";
            }, 1500);
        }

        // --- سحب اللاعب ---
        let selected = null;
        const ray = new THREE.Raycaster();
        const m = new THREE.Vector2();

        window.addEventListener('touchstart', e => {
            if(!isPlayerTurn) return;
            const t = e.touches[0];
            m.x = (t.clientX/window.innerWidth)*2-1; m.y = -(t.clientY/window.innerHeight)*2+1;
            ray.setFromCamera(m, camera);
            const hits = ray.intersectObjects(playerHand, true);
            if(hits.length > 0) {
                let o = hits[0].object; while(o.parent && o.userData.owner!=='player') o = o.parent;
                selected = o; selected.position.y = 1.5;
            }
        });

        window.addEventListener('touchmove', e => {
            if(!selected) return;
            const t = e.touches[0];
            m.x = (t.clientX/window.innerWidth)*2-1; m.y = -(t.clientY/window.innerHeight)*2+1;
            ray.setFromCamera(m, camera);
            const hit = ray.intersectObject(felt);
            if(hit.length > 0) selected.position.set(hit[0].point.x, 1.2, hit[0].point.z);
        });

        window.addEventListener('touchend', () => {
            if(!selected) return;
            let played = false;
            const p = selected.position;
            if(p.distanceTo(new THREE.Vector3(edges.r.x, 0, 0)) < 3.5) { snap(selected, 'r'); played = true; }
            else if(p.distanceTo(new THREE.Vector3(edges.l.x, 0, 0)) < 3.5) { snap(selected, 'l'); played = true; }

            if(played) {
                playerHand = playerHand.filter(t => t !== selected);
                document.getElementById('player-count').innerText = playerHand.length;
                playClack();
                isPlayerTurn = false;
                aiPlay();
            } else {
                selected.position.set(selected.userData.ox, 0.15, selected.userData.oz);
            }
            selected.position.y = 0.15; selected = null;
        });

        function snap(tile, side) {
            const isD = tile.userData.isD;
            const target = edges[side];
            tile.position.set(side==='r' ? target.x+(isD?0.6:1.1) : target.x-(isD?0.6:1.1), 0.15, 0);
            tile.rotation.y = isD ? 0 : Math.PI/2;
            
            // تحديث قيم الأطراف
            const newVal = (tile.userData.v1 === target.val) ? tile.userData.v2 : tile.userData.v1;
            target.val = newVal;
            target.x = tile.position.x + (side==='r' ? (isD?0.5:1) : (isD?-0.5:-1));
            tile.userData.owner = 'board';
        }

        function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }
        animate();
    </script>
</body>
</html>
