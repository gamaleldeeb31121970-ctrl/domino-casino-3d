
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Domino Casino 3D - Final Fix</title>
    <style>
        /* كل التنسيقات هنا لضمان عدم حدوث تداخل مع ملفات قديمة */
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; font-family: sans-serif; }
        .badge { position: absolute; background: rgba(0,0,0,0.8); color: #ffd700; padding: 8px 15px; border: 1px solid #ffd700; border-radius: 5px; font-size: 12px; font-weight: bold; }
        #status { position: absolute; bottom: 12%; width: 100%; text-align: center; color: #fff; text-shadow: 0 2px 5px #000; font-weight: bold; }
    </style>
</head>
<body>
    <div id="overlay">
        <div class="badge" style="top: 10px; left: 10px;">أنت: <span id="p-score">7</span></div>
        <div class="badge" style="top: 10px; right: 10px;">الخصم: <span id="ai-score">7</span></div>
        <div id="status">جاري التحميل...</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // كود الـ JavaScript مدمج بالكامل هنا
        let scene, camera, renderer, table;
        let pHand = [], aiHand = [], board = [];
        let edges = { l: {x: -1.3, v: 6}, r: {x: 1.3, v: 6} };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x011a07);

            camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 11, 9);
            camera.lookAt(0, -2, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);

            const sun = new THREE.DirectionalLight(0xffffff, 0.8);
            sun.position.set(5, 15, 10);
            sun.castShadow = true;
            scene.add(sun);

            // الطاولة الخضراء
            table = new THREE.Mesh(
                new THREE.BoxGeometry(40, 0.5, 40),
                new THREE.MeshStandardMaterial({ color: 0x0a4d1a })
            );
            table.receiveShadow = true;
            table.position.y = -0.3;
            scene.add(table);

            setupGame();
            document.getElementById('status').innerText = "اسحب الحجر وضعه في مكانه";
            animate();
        }

        function createTile(v1, v2, x, z, isPlayer) {
            const group = new THREE.Group();
            
            // جسم الحجر (سميك)
            const body = new THREE.Mesh(
                new THREE.BoxGeometry(1.2, 0.6, 2.4),
                new THREE.MeshStandardMaterial({ color: 0xfdfdf5, roughness: 0.1 })
            );
            body.castShadow = true;
            group.add(body);

            // مسمار ذهبي
            const pivot = new THREE.Mesh(new THREE.SphereGeometry(0.08, 16, 16), new THREE.MeshStandardMaterial({color: 0xffd700, metalness: 1}));
            pivot.position.y = 0.31;
            group.add(pivot);

            // النقاط
            const addDots = (val, offset) => {
                const g = 0.35; let pts = [];
                if(val%2!==0) pts.push([0,0]);
                if(val>=2) pts.push([g,g], [-g,-g]);
                if(val>=4) pts.push([-g,g], [g,-g]);
                if(val===6) pts.push([g,0], [-g,0]);
                pts.forEach(p => {
                    const dot = new THREE.Mesh(new THREE.SphereGeometry(0.1, 12, 12), new THREE.MeshStandardMaterial({color: 0x111}));
                    dot.position.set(p[0], 0.3, offset + p[1]);
                    group.add(dot);
                });
            };

            if(isPlayer !== 'ai') { addDots(v1, 0.6); addDots(v2, -0.6); }
            else { group.rotation.x = Math.PI; }

            group.position.set(x, 0.3, z);
            group.userData = { v1, v2, ox: x, oz: z, owner: isPlayer, isD: v1===v2 };
            scene.add(group);
            return group;
        }

        function setupGame() {
            let pool = [];
            for(let i=0; i<=6; i++) for(let j=i; j<=6; j++) pool.push([i,j]);
            pool.sort(() => Math.random() - 0.5);

            for(let i=0; i<7; i++) pHand.push(createTile(...pool.pop(), -4 + (i*1.3), 7, 'p'));
            for(let i=0; i<7; i++) aiHand.push(createTile(...pool.pop(), -4 + (i*1.3), -7, 'ai'));
            
            createTile(6, 6, 0, 0, 'board');
        }

        // تحكم اللمس
        let selected = null;
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('touchstart', (e) => {
            const t = e.touches[0];
            mouse.x = (t.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(t.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObjects(pHand, true);
            if(hits.length > 0) {
                let obj = hits[0].object;
                while(obj.parent && obj.userData.owner !== 'p') obj = obj.parent;
                selected = obj;
            }
        });

        window.addEventListener('touchmove', (e) => {
            if(!selected) return;
            const t = e.touches[0];
            mouse.x = (t.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(t.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObject(table);
            if(hits.length > 0) {
                selected.position.set(hits[0].point.x, 1, hits[0].point.z);
            }
        });

        window.addEventListener('touchend', () => {
            if(!selected) return;
            // منطق الالتحام المبسط
            if(selected.position.distanceTo(new THREE.Vector3(edges.r.x, 0, 0)) < 3) {
                snapTile(selected, 'r');
                pHand = pHand.filter(t => t !== selected);
                document.getElementById('p-score').innerText = pHand.length;
            } else {
                selected.position.set(selected.userData.ox, 0.3, selected.userData.oz);
            }
            selected = null;
        });

        function snapTile(t, side) {
            t.position.set(edges[side].x + (side==='r'?1.2:-1.2), 0.3, 0);
            t.rotation.y = Math.PI/2;
            edges[side].x = t.position.x;
            t.userData.owner = 'board';
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        init();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
